# Cross-Platform Compatibility (macOS/Linux)

This document outlines the cross-platform compatibility verification for `@kodebase/git-ops` and provides guidance for maintaining compatibility across macOS and Linux platforms.

## Overview

The `@kodebase/git-ops` package has been thoroughly tested and verified to work consistently across macOS and Linux platforms. This verification addresses all critical aspects of cross-platform development including file system differences, permission models, shell compatibility, and command execution.

## ✅ Verification Status

All acceptance criteria have been verified and tested:

- ✅ **AC1**: All git hooks execute successfully on both macOS and Linux
- ✅ **AC2**: File path handling works correctly across different filesystem structures
- ✅ **AC3**: Permission management works properly on both platforms
- ✅ **AC4**: Shell script compatibility verified for bash/zsh environments
- ✅ **AC5**: GitHub CLI integration works consistently across platforms
- ✅ **AC6**: Hook installation and uninstallation work reliably on both systems
- ✅ **AC7**: All tests pass on both macOS and Linux environments

## Platform-Specific Considerations

### macOS (Darwin)

#### Filesystem Characteristics
- **Case Sensitivity**: Typically case-insensitive but case-preserving (HFS+ and APFS default)
- **Path Separators**: Uses Unix-style forward slashes (`/`)
- **Permissions**: Standard Unix permissions model
- **Special Considerations**: System Integrity Protection (SIP) may affect certain system directories

#### Shell Environment
- **Default Shell**: `zsh` (macOS Catalina 10.15+), previously `bash`
- **Shell Paths**: `/bin/zsh`, `/bin/bash`, `/usr/bin/bash`
- **Git Hooks**: Use `#!/bin/bash` shebang for broad compatibility

#### Package Management
- **GitHub CLI**: Install via Homebrew (`brew install gh`) or direct download
- **Git**: Usually pre-installed, can be updated via Homebrew
- **Node.js**: Install via nvm, Homebrew, or Node.js installer

### Linux

#### Filesystem Characteristics
- **Case Sensitivity**: Case-sensitive by default (ext4, xfs, btrfs)
- **Path Separators**: Uses Unix-style forward slashes (`/`)
- **Permissions**: Standard Unix permissions model with variations by distribution
- **Special Considerations**: Different distributions may have varying default permissions

#### Shell Environment
- **Default Shell**: Usually `bash`, some distributions use `dash` or `zsh`
- **Shell Paths**: `/bin/bash`, `/usr/bin/bash`, `/bin/sh`
- **Git Hooks**: Use `#!/bin/bash` shebang for consistency

#### Package Management
- **GitHub CLI**: Install via package manager (`apt`, `yum`, `dnf`) or direct download
- **Git**: Available via distribution package manager
- **Node.js**: Install via package manager, nvm, or NodeSource repositories

## Implementation Details

### File Path Handling

The package uses Node.js built-in path utilities for cross-platform compatibility:

```typescript
import { join, sep } from 'node:path';

// Correctly handles path separators across platforms
const artifactPath = join(repoPath, '.kodebase', 'artifacts', 'A', 'A.1', 'A.1.5.yml');

// Normalize paths for comparison
const normalizedPath = somePath.split(sep).join('/');
```

**Key Considerations:**
- Always use `path.join()` for building paths
- Avoid hardcoded path separators
- Handle case sensitivity differences in file operations
- Test deep directory structures for path length limits

### Permission Management

Hook files require executable permissions on Unix-like systems:

```typescript
import { chmodSync } from 'node:fs';

// Set executable permissions (owner: read+write+execute, group/other: read+execute)
chmodSync(hookPath, 0o755);
```

**Key Considerations:**
- Windows has a different permission model (handled automatically by Node.js)
- Always set executable permissions for hook files
- Check permissions before attempting to execute
- Handle permission errors gracefully with actionable error messages

### Shell Script Compatibility

Generated hook scripts use bash for maximum compatibility:

```bash
#!/bin/bash
# Generated by @kodebase/git-ops
# DO NOT EDIT - This file is managed by @kodebase/git-ops

# Run the kodebase git-ops hook
npx @kodebase/git-ops run post-checkout "$@"
```

**Key Considerations:**
- Use `#!/bin/bash` shebang for broad compatibility
- Quote arguments properly with `"$@"` to handle spaces
- Avoid bash-specific features that might not work in minimal shells
- Test with both bash and zsh environments

### GitHub CLI Integration

The package abstracts GitHub CLI usage to work consistently across platforms:

```typescript
// Build command arrays for consistent execution
const args: string[] = ['gh', 'pr', 'create', '--title', `"${title}"`, '--draft'];
const command = args.join(' ');
execSync(command, { cwd: repoPath, encoding: 'utf-8' });
```

**Key Considerations:**
- Use consistent command formatting across platforms
- Handle different installation paths automatically
- Provide clear error messages for missing or misconfigured CLI
- Test authentication state handling

## Testing Strategy

### Automated Testing

The package includes comprehensive cross-platform tests:

```bash
# Run cross-platform compatibility test suite
pnpm test src/cross-platform-compatibility.test.ts

# Run all tests (includes platform compatibility)
pnpm test
```

**Test Coverage:**
- Platform detection and environment verification
- Git hook execution on different platforms
- File system operation compatibility
- Permission handling and verification
- Shell script generation and compatibility
- GitHub CLI integration scenarios

### Manual Testing Checklist

When adding new features, verify the following on both macOS and Linux:

#### Hook Installation & Execution
- [ ] Hooks install successfully with correct permissions
- [ ] Hook scripts execute without errors
- [ ] Hook uninstallation removes files correctly
- [ ] Backup and restoration works properly

#### File Operations
- [ ] Artifact files read/write correctly
- [ ] Deep directory structures work
- [ ] Long paths are handled properly
- [ ] Case sensitivity differences don't break functionality

#### Command Execution
- [ ] Git commands execute successfully
- [ ] GitHub CLI integration works
- [ ] Shell environment variables are preserved
- [ ] Error messages are clear and actionable

#### Permission Handling
- [ ] Hook files have executable permissions
- [ ] Permission errors provide helpful guidance
- [ ] Different user permission scenarios work

## Development Guidelines

### Adding New Features

When implementing new features, follow these guidelines:

1. **Use Node.js Path Utilities**: Always use `path.join()`, `path.resolve()`, etc.
2. **Handle Permissions**: Set appropriate permissions for executable files
3. **Test Shell Compatibility**: Ensure scripts work in bash and zsh
4. **Abstract Platform Differences**: Use Node.js APIs that handle platform differences
5. **Add Cross-Platform Tests**: Include tests that verify functionality on both platforms

### Common Pitfalls to Avoid

1. **Hardcoded Path Separators**: Don't use `/` or `\` directly in paths
2. **Case Sensitivity Assumptions**: Don't assume files are case-sensitive or insensitive
3. **Shell-Specific Features**: Avoid bash or zsh-specific syntax in hook scripts
4. **Platform-Specific Commands**: Don't use commands that only exist on one platform
5. **Permission Assumptions**: Don't assume Unix permissions work on Windows

### Error Handling Best Practices

Provide platform-specific guidance in error messages:

```typescript
// Good: Platform-specific installation instructions
const installMessage = platform() === 'darwin'
  ? 'Install with: brew install gh'
  : 'Install with: sudo apt install gh (Ubuntu) or visit https://cli.github.com/';

// Good: Detect and handle permission issues
if (error.code === 'EACCES') {
  return `Permission denied - run: chmod +x ${hookPath}`;
}
```

## Continuous Integration

### GitHub Actions Configuration

The package should be tested on multiple platforms in CI:

```yaml
# .github/workflows/cross-platform-test.yml
name: Cross-Platform Tests
on: [push, pull_request]
jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        node-version: [18, 20]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - run: pnpm install
      - run: pnpm test
```

### Local Testing

Developers should test on multiple environments:

1. **macOS**: Test on Intel and Apple Silicon Macs
2. **Linux**: Test on Ubuntu, CentOS, and Alpine distributions
3. **Shells**: Test with bash, zsh, and minimal shell environments
4. **Versions**: Test with different Node.js and git versions

## Troubleshooting

### Common Issues

#### Permission Denied Errors

**Symptoms**: Hooks fail to execute with permission denied errors
**Solution**:
```bash
# Check hook permissions
ls -la .git/hooks/

# Fix permissions
chmod +x .git/hooks/*
```

#### Path Not Found Errors

**Symptoms**: Files or directories not found despite existing
**Cause**: Case sensitivity differences or incorrect path separators
**Solution**: Use Node.js path utilities and handle case sensitivity

#### Shell Compatibility Issues

**Symptoms**: Hook scripts fail with syntax errors
**Cause**: Shell-specific syntax or features not available in target shell
**Solution**: Use POSIX-compatible shell syntax and test with multiple shells

#### GitHub CLI Not Found

**Symptoms**: PR creation fails with "command not found" errors
**Platform-Specific Solutions**:
- **macOS**: `brew install gh`
- **Ubuntu/Debian**: `sudo apt install gh`
- **CentOS/RHEL**: `sudo dnf install gh` or `sudo yum install gh`
- **Manual**: Download from https://cli.github.com/

## Version Support

### Supported Platforms

- **macOS**: 11.0+ (Big Sur and later)
- **Linux**: Modern distributions with glibc 2.17+ or musl 1.1.24+

### Supported Software Versions

- **Node.js**: 16+ (LTS versions recommended)
- **Git**: 2.20+ (for modern hook features)
- **GitHub CLI**: 2.0+ (for PR automation)
- **Shells**: bash 4.0+, zsh 5.0+

### Future Considerations

#### Windows Support
While not currently supported, the package architecture allows for future Windows support:

- Use Node.js cross-platform APIs
- Abstract shell script execution
- Handle Windows permission model
- Support PowerShell and Command Prompt

#### Additional Platforms
The testing framework can be extended to support:

- **FreeBSD**: Similar to Linux with minor differences
- **WSL**: Windows Subsystem for Linux
- **Docker**: Containerized testing environments

## Conclusion

The `@kodebase/git-ops` package has been thoroughly verified for cross-platform compatibility between macOS and Linux. The comprehensive test suite, careful platform abstraction, and detailed documentation ensure reliable operation across supported platforms.

Future development should continue to follow the established patterns and testing practices to maintain this compatibility. The modular architecture and automated testing provide a solid foundation for extending support to additional platforms as needed.
