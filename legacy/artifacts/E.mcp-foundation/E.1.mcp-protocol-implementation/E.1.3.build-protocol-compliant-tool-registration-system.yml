metadata:
  title: Build protocol-compliant tool registration system
  priority: high
  estimation: M
  created_by: Miguel Carvalho (m@kodebase.ai)
  assignee: Miguel Carvalho (m@kodebase.ai)
  schema_version: 2.0.0
  relationships:
    blocks: [ E.2 ]
    blocked_by: [ E.1.1, E.1.2 ]
  events:
    - event: draft
      timestamp: 2025-07-30T14:34:00Z
      actor: Miguel Carvalho (m@kodebase.ai)
      trigger: artifact_created
    - event: ready
      timestamp: 2025-07-30T17:22:17Z
      actor: Github Actions (github-actions[bot]@users.noreply.github.com)
      trigger: dependencies_met
    - event: in_progress
      timestamp: 2025-07-30T17:24:06Z
      actor: Miguel Carvalho (m@kodebase.ai)
      trigger: branch_created
      metadata:
        branch_created: E.1.3
    - event: in_review
      timestamp: 2025-07-30T17:57:43Z
      actor: Miguel Carvalho (m@kodebase.ai)
      trigger: pr_created
      metadata:
        pr_ready_for_review: true
    - event: completed
      timestamp: 2025-07-30T17:59:03Z
      actor: Github Actions (github-actions[bot]@users.noreply.github.com)
      trigger: pr_merged

content:
  summary: >
    Create the framework for registering and managing MCP tools that will
    provide access to Kodebase artifacts and context. This system must follow
    MCP protocol specifications for tool discovery, registration, and
    invocation. Sets up the foundation for all the specific tools that will be
    implemented in E.4.

  acceptance_criteria:
    - MCP tool registration interface implemented
    - Tool discovery endpoint responds correctly to list_tools requests
    - Tool invocation framework handles call_tool requests
    - Proper schema validation for tool definitions
    - Error handling for invalid tool calls
    - MCP inspector can discover and display registered tools

development_process:
  alternatives_considered:
    - "Custom JSON-RPC handler implementation: Rejected due to complexity and
      protocol compliance risk"
    - "Direct tool registration without validation: Rejected due to lack of type
      safety and error handling"
    - "Using alternative MCP libraries: Rejected in favor of official
      @modelcontextprotocol/sdk for maximum compatibility"
    - "Complex abstraction layer over MCP SDK: Rejected following Constitution's
      'Reject Complexity' principle"
  challenges_encountered:
    - challenge: "MCP SDK type definitions were not immediately clear for tool
        registration"
      solution: "Explored SDK API using Node.js inspection to understand correct
        method signatures and parameters"
    - challenge: "Balancing our own validation layer with MCP SDK's built-in validation"
      solution: "Used dual registration approach - validate with our Zod schemas then
        register with MCP SDK"
    - challenge: "TypeScript type conflicts between JSON Schema format and MCP SDK
        expectations"
      solution: "Used careful type casting with explanatory comments for SDK interface
        compatibility"

completion_analysis:
  key_insights:
    - "MCP SDK provides excellent built-in tool registration and protocol
      handling"
    - "Dual validation approach (Zod + MCP SDK) provides both type safety and
      protocol compliance"
    - "Tool registry pattern enables extensibility while maintaining simplicity"
    - "Integration tests are crucial for verifying MCP protocol compliance"
  implementation_approach:
    - "Created ToolRegistry class for internal tool management and validation"
    - "Integrated with MCP SDK's registerTool method for protocol compliance"
    - "Used Zod for schema validation following project patterns from
      @kodebase/core"
    - "Implemented comprehensive error handling for tool execution failures"
    - "Built extensive test suite covering all acceptance criteria (52 tests)"
  knowledge_generated:
    - "Understanding of MCP protocol tool registration requirements"
    - "Experience with @modelcontextprotocol/sdk API and best practices"
    - "Pattern for bridging external APIs with internal validation systems"
    - "Comprehensive testing strategies for protocol compliance verification"

notes: |
  This establishes the framework that E.4 will use to register specific tools like
  getArtifacts, getContext, etc. The system must be extensible and follow MCP
  best practices for tool definition and invocation.

  Files created:
  - packages/mcp-server/src/tools/registry.ts: Core tool registration system
  - packages/mcp-server/src/tools/registry.test.ts: Comprehensive registry tests (19 tests)
  - packages/mcp-server/src/tools/integration.test.ts: MCP integration tests (13 tests)

  Integration points:
  - Extends existing KodebaseMcpServer with tool registration capabilities
  - Uses @kodebase/core patterns (Zod validation, TypeScript types)
  - Integrates with @modelcontextprotocol/sdk for protocol compliance
  - Ready for E.4 to register specific Kodebase tools
