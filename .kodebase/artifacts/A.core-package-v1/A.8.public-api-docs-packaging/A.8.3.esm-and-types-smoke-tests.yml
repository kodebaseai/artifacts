metadata:
  title: ESM exports and type declarations smoke tests
  priority: high
  estimation: S
  created_by: "Miguel Carvalho (m@kodebase.ai)"
  assignee: "Miguel Carvalho (m@kodebase.ai)"
  schema_version: "0.0.1"
  relationships:
    blocks: []
    blocked_by: [A.8.2]
  events:
    - event: draft
      timestamp: "2025-10-28T10:40:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: artifact_created
    - event: blocked
      timestamp: "2025-10-28T14:44:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: has_dependencies
      metadata:
        blocking_dependencies:
          - artifact_id: A.8.2
            resolved: true
    - event: ready
      timestamp: "2025-11-01T22:38:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: dependencies_met
    - event: in_progress
      timestamp: "2025-11-01T22:45:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: branch_created
    - event: in_review
      timestamp: "2025-11-01T23:31:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: pr_ready
    - event: completed
      timestamp: "2025-11-01T23:36:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: pr_merged
content:
  summary: >-
    Add smoke tests to ensure ESM consumers can import curated exports and that
    generated type declarations are correct and complete.
  acceptance_criteria:
    - 'Minimal consumer project can import from @kodebase/core without bundler hacks'
    - 'd.ts files contain the public API types; no missing/any typings'
    - 'CI runs smoke tests as part of the core build pipeline'
  implementation_notes:
    result: >-
      Complete build infrastructure and smoke tests implemented: TypeScript compilation to dist/,
      comprehensive ESM import validation (12 module groups), type completeness tests, package
      validation tools (publint, attw), and CI integration. All 333 unit tests + smoke tests passing.
      Fixed Zod v4 type bugs with skipLibCheck workaround and exported missing types (TArtifactMetadata, TEvent).
    tags: [build, esm, typescript, smoke-tests, package-validation, ci, type-declarations]
    changes:
      - change: "Configured TypeScript compilation (tsconfig.json: noEmit: false, outDir: dist)"
        rationale: "Package was distributing raw TypeScript source - consumers need compiled JavaScript with type declarations"
      - change: "Updated package.json exports to point to dist/ output (.js and .d.ts files)"
        rationale: "Module resolution must point to compiled artifacts, not source files"
      - change: "Fixed import path in artifact-scaffolder.ts (src/schemas â†’ ../schemas)"
        rationale: "Absolute import paths break TypeScript declaration generation"
      - change: "Created test/smoke/ with esm-import.test.ts (runtime) and type-completeness.test.ts (compile-time)"
        rationale: "Validates package works from consumer perspective without bundler hacks - catches missing exports, broken types, incorrect module resolution"
      - change: "Added skipLibCheck: true to smoke test tsconfig.json"
        rationale: "Workaround for Zod v4.1.12 bug in v4/locales/index.d.cts requiring esModuleInterop - upstream library issue, not our code"
      - change: "Exported TArtifactMetadata and TEvent types from src/schemas/schemas.ts"
        rationale: "Types were defined but not exported - consumers couldn't access them from public API"
      - change: "Added @arethetypeswrong/cli and publint with lint:package and lint:types scripts"
        rationale: "Automated package validation catches publishing issues before they reach npm"
      - change: "Added smoke-test-core job to CI workflow"
        rationale: "Ensures every build produces consumable package - acceptance criterion requires CI integration"
      - change: "Excluded test/smoke/ from vitest.config.ts"
        rationale: "Smoke tests run separately with tsx/tsc - not part of unit test suite"
      - change: "Added Package Structure section to README.md"
        rationale: "Documents build process and package integrity testing for contributors"
    insights:
      - "Build was completely missing - package.json had 'build: echo no build step' and exported raw .ts files"
      - "ESM smoke tests validate all 12 public module groups work without bundler configuration"
      - "Type completeness tests caught 2 missing exports (TArtifactMetadata, TEvent) and 1 wrong import path"
      - "Zod v4 locale bug affects 38+ type declarations but doesn't impact runtime - skipLibCheck is industry standard workaround"
      - "publint validation passes - package.json exports correctly configured for dual ESM/type resolution"
      - "attw shows correct behavior: works from ESM, CJS needs dynamic import (expected for pure ESM package)"
      - "All 333 unit tests maintained at 97% coverage throughout implementation"
      - "Smoke tests use relative imports (../../dist/index.js) to verify actual package output, not source"
      - "CI now validates package consumability on every build - acceptance criteria fully met"
      - "Package now ready for npm publishing with proper dist/ artifacts, type declarations, and source maps"
