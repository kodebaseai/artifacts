metadata:
  title: Enforce same-parent constraints for milestones and issues
  priority: high
  estimation: S
  created_by: "Miguel Carvalho (m@kodebase.ai)"
  assignee: "Miguel Carvalho (m@kodebase.ai)"
  schema_version: "0.0.1"
  relationships:
    blocks: [A.3.3]
    blocked_by: [A.3.1]
  events:
    - event: draft
      timestamp: "2025-10-28T09:57:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: artifact_created
    - event: blocked
      timestamp: "2025-10-28T14:44:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: has_dependencies
      metadata:
        blocking_dependencies:
          - artifact_id: A.3.1
            resolved: false
            resolved_at: "2025-10-30T23:28:00Z"
    - event: ready
      timestamp: "2025-10-30T23:28:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: dependencies_met
    - event: in_progress
      timestamp: "2025-10-30T23:30:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: branch_created
    - event: in_review
      timestamp: "2025-10-31T00:10:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: pr_ready
    - event: completed
      timestamp: "2025-10-31T00:13:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: pr_merged
content:
  summary: >-
    Ensure milestone dependencies are limited to milestones within the same initiative (A.X ↔ A.*),
    and issue dependencies are limited to issues within the same milestone (A.X.Y ↔ A.X.*)
    using ID prefix comparisons.
  acceptance_criteria:
    - Validator checks ID prefixes to assert same-parent relationships
    - Violations produce specific error codes and actionable messages
    - Unit tests cover valid and invalid same-parent scenarios
  implementation_notes:
    result: "Relationship validator now enforces same-parent constraints with prefix-aware error codes and actionable messaging."
    tags: [core, validation, dependencies]
    challenges:
      - challenge: "Existing fixtures and tests assumed generic relationship errors, causing noisy regressions when messages became more specific."
        solution: "Updated fixtures and expectations to capture the new structured codes/messages emitted by the validator."
      - challenge: "Maintaining compatibility with Zod v4 after `ZodIssueCode` deprecation while still surfacing issue codes."
        solution: "Stored Zod's string-based codes directly on parse issues, avoiding deprecated enums without losing metadata."
    insights:
      - "Prefix comparisons keep same-parent checks simple and deterministic while delivering user-friendly hints."
      - "Embedding error codes on parser issues makes validator outputs more programmable for downstream tooling."
