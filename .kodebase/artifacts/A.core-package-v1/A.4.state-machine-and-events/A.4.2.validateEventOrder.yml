metadata:
  title: Implement validateEventOrder (chronology enforcement)
  priority: high
  estimation: S
  created_by: "Miguel Carvalho (m@kodebase.ai)"
  assignee: "Miguel Carvalho (m@kodebase.ai)"
  schema_version: "0.0.1"
  relationships:
    blocks: [A.4.3]
    blocked_by: [A.4.1]
  events:
    - event: draft
      timestamp: "2025-10-28T10:06:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: artifact_created
    - event: blocked
      timestamp: "2025-10-28T14:44:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: has_dependencies
      metadata:
        blocking_dependencies:
          - artifact_id: A.4.1
            resolved: true
            resolved_at: "2025-10-31T13:19:00Z"
    - event: ready
      timestamp: "2025-10-31T13:19:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: dependencies_met
    - event: in_progress
      timestamp: "2025-10-31T13:25:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: branch_created
    - event: in_review
      timestamp: "2025-10-31T13:40:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: pr_ready
    - event: completed
      timestamp: "2025-10-31T13:45:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: pr_merged
content:
  summary: >-
    Enforce chronological ordering of events per artifact, ensuring the first event
    is draft and subsequent events are in non-decreasing timestamp order.
  acceptance_criteria:
    - First event must be `draft`, otherwise validation fails with a specific error code
    - Events must be in chronological (non-decreasing) order; out-of-order sequences are rejected
    - Error messages include the offending timestamps to aid debugging
implementation_notes:
  result: >-
    Added `validateEventOrder` with strict first-event draft enforcement and non-decreasing timestamp checks. Introduced
    `EventOrderError` with codes (EMPTY_EVENTS, FIRST_EVENT_MUST_BE_DRAFT, EVENTS_OUT_OF_ORDER). Tests verify all cases.
  tags: [core, state-machine, events, validation]
  challenges:
    - challenge: "Ensuring consumers receive actionable, programmatic error info"
      solution: "Added an error class with explicit codes and timestamp details for out-of-order violations."
    - challenge: "Allowing equal timestamps while rejecting regressions"
      solution: "Used non-decreasing time comparison (>= allowed), matching spec and legacy behavior."
    - challenge: "Avoid schema duplication for invalid timestamps"
      solution: "Validator skips order checks when timestamps are invalid; schema validation already handles formats."
  insights:
    - "Separating order validation from transition validation keeps concerns clear and errors focused."
    - "Surfacing the exact timestamps and index speeds up debugging for event authors and automations."
