metadata:
  title: State Machine and Events
  priority: high
  estimation: S
  created_by: "Miguel Carvalho (m@kodebase.ai)"
  assignee: "Miguel Carvalho (m@kodebase.ai)"
  schema_version: "0.0.1"
  relationships:
    blocks: [A.5]
    blocked_by: [A.3]
  events:
    - event: draft
      timestamp: "2025-10-27T20:48:44Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: artifact_created
    - event: blocked
      timestamp: "2025-10-28T14:44:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: has_dependencies
      metadata:
        blocking_dependencies:
          - artifact_id: A.3
            resolved: true
            resolved_at: "2025-10-31T12:53:00Z"
    - event: ready
      timestamp: "2025-10-31T12:53:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: dependencies_met
    - event: in_progress
      timestamp: "2025-10-31T12:58:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: children_started
    - event: in_review
      timestamp: "2025-10-31T14:55:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: pr_ready
    - event: completed
      timestamp: "2025-10-31T15:00:00Z"
      actor: "Miguel Carvalho (m@kodebase.ai)"
      trigger: pr_merged
content:
  summary: >-
    Define valid transitions per artifact type and chronological constraints;
    require explicit triggers for event creation.
  deliverables:
    - canTransition and getValidTransitions utilities per artifact type
    - validateEventOrder enforcing chronological sequencing; first event is draft
    - EventBuilder requiring explicit trigger; helpers for draft/ready
  validation:
    - Invalid transitions are rejected with informative errors
    - Sequences violating chronology fail validation
    - Builder refuses events without a trigger; unit tests cover edge cases
delivery_summary:
  outcome: >-
    State machine utilities, event chronology validation, and trigger-enforced
    event builder are implemented with comprehensive unit tests and golden fixtures.
  delivered:
    - Transition maps per artifact type with `canTransition`, `getValidTransitions`, and `assertTransition` exported from core.
    - Chronology validator `validateEventOrder` plus `EventOrderError` codes (EMPTY_EVENTS, FIRST_EVENT_MUST_BE_DRAFT, EVENTS_OUT_OF_ORDER).
    - EventBuilder requiring explicit `trigger` with `EVENT_TRIGGER_BY_EVENT` guard and helpers (draft/ready/blocked/in_progress/in_review/completed/cancelled/archived).
    - Fixture-backed tests covering valid lifecycle, equal timestamps (allowed), and out-of-order rejection.
    - YAML fixtures for lifecycle scenarios and an accompanying changeset for release notes.
  next: >-
    Expose transition and order checks inside higher-level workflows (CLI/IDE);
    expand fixtures as additional artifact rules emerge in A.5.
