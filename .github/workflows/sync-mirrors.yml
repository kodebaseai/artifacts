name: Sync Public Mirrors

on:
  push:
    branches: [main]
    paths:
      - 'packages/**'
      - '.changeset/**'
  workflow_dispatch:

permissions:
  contents: read  # Least privilege for the source repo

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync-mirrors:
    name: Sync Public Mirrors
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['24']
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          fetch-depth: 2
          persist-credentials: false

      - name: Setup pnpm
        uses: ./.github/actions/setup-pnpm
        with:
          node-version: ${{ matrix.node-version }}

      - name: Lint
        run: pnpm lint
        env: { CI: true }

      # Ensure this is a non-mutating check (e.g. prettier --check)
      - name: Format check
        run: pnpm format
        env: { CI: true }

      - name: Type check
        run: pnpm check-types
        env: { CI: true }

      - name: Run tests
        run: pnpm test -- --coverage
        env: { CI: true }

      - name: Build packages
        run: pnpm build
        env: { CI: true }

      # Sync public mirrors for changed packages
      - name: Sync public mirrors
        env:
          MIRROR_GITHUB_TOKEN: ${{ secrets.MIRROR_GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if [ -z "${MIRROR_GITHUB_TOKEN:-}" ]; then
            echo "MIRROR_GITHUB_TOKEN is not set. Add it as a repo secret." >&2
            exit 1
          fi

          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Determine base and head commits for diff
          if [ "${{ github.event_name }}" = "push" ]; then
            base="${{ github.event.before }}"
            head="${{ github.sha }}"
          else
            # For workflow_dispatch (no 'before'), compare to previous commit
            base="$(git rev-parse HEAD~1 || true)"
            head="$(git rev-parse HEAD)"
          fi

          # Function to sync a package to its mirror
          sync_package() {
            local package_name="$1"
            local mirror_repo="$2"

            echo "Checking for changes in packages/${package_name}..."

            # Check if package has changes
            if [ -n "$base" ] && git diff --quiet "$base" "$head" -- "packages/${package_name}"; then
              echo "No changes detected in packages/${package_name}, skipping sync"
              return 0
            fi

            echo "Changes detected in packages/${package_name}, syncing to ${mirror_repo}..."

            # Clone the mirror repository
            git clone "https://github.com/${mirror_repo}.git" "${package_name}-mirror"

            # Sync package contents into repo root but keep repo metadata and CI files
            rsync -av --delete \
              --exclude "node_modules" \
              --exclude ".git" \
              --exclude ".github" \
              "packages/${package_name}/" "${package_name}-mirror/"

            cd "${package_name}-mirror"
            git status --porcelain
            git add -A

            if git commit -m "Sync ${package_name} package from ${{ github.repository }}@${{ github.sha }}"; then
              # Push using the token without storing credentials (with tags)
              git push --follow-tags "https://x-access-token:${MIRROR_GITHUB_TOKEN}@github.com/${mirror_repo}.git" HEAD:main
              echo "Successfully synced ${package_name} to ${mirror_repo}"
            else
              echo "No changes to commit for ${package_name}"
            fi

            cd ..
          }

          # Sync each package that has a public mirror
          sync_package "core" "kodebaseai/core"
          sync_package "artifacts" "kodebaseai/artifacts"
